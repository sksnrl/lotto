<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🐧 채안 레이싱</title>
  <style>
    :root{
      --bg1:#0ea5e9;
      --bg2:#111827;
      --card:#0b1220cc;
      --lane:#0f172a;
      --lane-alt:#111827;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial;
      background: radial-gradient(70% 60% at 70% 10%, #38bdf8 0%, var(--bg1) 30%, var(--bg2) 100%);
      color:#e5e7eb;
      padding:20px;
    }
    .app{max-width:1100px;margin:auto}
    .card{
      background:var(--card);
      border-radius:24px;
      padding:18px;
    }
    h1{margin:6px 0 14px;font-size:28px;}
    .controls{margin-bottom:12px;}
    .row{margin:8px 0;}
    input,select{
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid #243045;
      border-radius:12px;
      padding:6px 10px;
      margin-right:6px;
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:8px 14px;
      font-weight:700;
      cursor:pointer;
      background: linear-gradient(180deg, #22d3ee, #0ea5e9);
      color:#0b1220;
    }
    .track{
      position:relative;
      height:auto;
      max-height:400px;
      padding:12px;
      border-radius:18px;
      background:#0d1529;
      overflow-x:auto;
      white-space:nowrap;
    }
    .lanes-wrapper{display:inline-block}
    .lane{
      position:relative;
      height:64px;
      margin:8px 0;
      border-radius:12px;
      background:linear-gradient(180deg,var(--lane),var(--lane-alt));
    }
    .penguin{
      position:absolute;
      left:0;top:50%;
      transform:translateY(-50%);
      font-size:28px;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .finish{
      position:absolute;top:0;bottom:0;right:0;width:20px;border-left:3px solid gold;
    }
    .results{margin-top:10px;font-size:14px}
    .badge{background:#0b1220;border:1px solid #243045;padding:4px 6px;border-radius:10px;margin-right:4px;}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>🐧 채안 레이싱</h1>
      <div class="controls">
        <div class="row">
          참가자 수 <input id="count" type="number" min="2" max="10" value="4"/>
          <button class="btn" id="applyCount">이름 입력칸 생성</button>
          모드 <select id="mode">
            <option value="random" selected>랜덤</option>
            <option value="steady">균등</option>
          </select>
          트랙 길이 <select id="length">
            <option value="short">짧게</option>
            <option value="normal" selected>보통</option>
            <option value="long">길게</option>
          </select>
        </div>
        <div class="row" id="nameFields"></div>
        <div class="row">
          <button class="btn" id="startBtn">레이스 시작</button>
          <button class="btn" id="resetBtn">초기화</button>
          <button class="btn" id="rerunBtn" disabled>재경기</button>
        </div>
      </div>

      <div class="track" id="track"><div class="lanes-wrapper"></div></div>
      <div class="results" id="results"></div>
    </div>
  </div>

  <script>
    const $=(s,r=document)=>r.querySelector(s);
    const state={racers:[],running:false,raf:null,lengthPx:0,finished:[],config:{mode:"random",length:"normal"}};

    const countInput=$('#count'),applyBtn=$('#applyCount'),nameFields=$('#nameFields'),
      trackEl=$('#track'),startBtn=$('#startBtn'),resetBtn=$('#resetBtn'),
      rerunBtn=$('#rerunBtn'),resultsEl=$('#results'),modeSel=$('#mode'),lenSel=$('#length');

    function makeNameFields(n){
      nameFields.innerHTML='';
      for(let i=0;i<n;i++){
        const input=document.createElement('input');
        input.type='text'; input.placeholder=`펭귄${i+1}`; input.id=`name-${i}`;
        nameFields.appendChild(input);
      }
    }
    function collectNames(){
      const n=Math.max(2,Math.min(10,parseInt(countInput.value||'4')));
      countInput.value=n;
      return Array.from({length:n},(_,i)=>$('#name-'+i)?.value?.trim()||`펭귄${i+1}`);
    }
    function buildTrack(names){
      trackEl.innerHTML='<div class="lanes-wrapper"></div>';
      const wrapper=$('.lanes-wrapper',trackEl);
      let laneLength=2000;
      if(state.config.length==='short') laneLength=1000;
      else if(state.config.length==='long') laneLength=5000;
      state.lengthPx=laneLength-60;
      state.racers=names.map((nm,i)=>{
        const lane=document.createElement('div');lane.className='lane';lane.style.width=laneLength+'px';
        const penguin=document.createElement('div');penguin.className='penguin';penguin.dataset.id=i;
        penguin.innerHTML=`🐧 <span class="pname">${nm}</span>`;
        const finish=document.createElement('div');finish.className='finish';
        lane.appendChild(penguin); lane.appendChild(finish); wrapper.appendChild(lane);
        return {id:i,name:nm,el:penguin,x:0,finishedAt:null,itemCooldown:0,shield:false};
      });
      state.finished=[]; resultsEl.innerHTML='';
    }
    function baseStep(){
      switch(state.config.length){
        case 'short':return 0.5;
        case 'long':return 0.3;
        default:return 0.4;
      }
    }
    function applyItem(r){
      const roll=Math.random();
      if(r.itemCooldown>0) return 0;
      if(roll<0.05){
        // 🚀 부스터
        r.el.firstChild.textContent="🚀🐧"; r.itemCooldown=80;
        setTimeout(()=>r.el.firstChild.textContent="🐧",800);
        return 5+Math.random()*3;
      }else if(roll<0.09){
        // 🍌 바나나
        r.el.firstChild.textContent="🍌🐧"; r.itemCooldown=80;
        setTimeout(()=>r.el.firstChild.textContent="🐧",800);
        return -(3+Math.random()*2);
      }else if(roll<0.12){
        // 🛡️ 방패
        r.shield=true; r.el.firstChild.textContent="🛡️🐧";
        setTimeout(()=>{r.shield=false;r.el.firstChild.textContent="🐧";},2000);
      }else if(roll<0.15){
        // ❄️ 얼음덫: 다른 랜덤 상대 둔화
        const others=state.racers.filter(o=>o.id!==r.id && o.finishedAt===null);
        if(others.length){
          const target=others[Math.floor(Math.random()*others.length)];
          target.slowUntil=performance.now()+2000;
          target.el.firstChild.textContent="❄️🐧";
          setTimeout(()=>target.el.firstChild.textContent="🐧",2000);
        }
      }
      return 0;
    }
    function tick(){
      state.racers.forEach(r=>{
        if(r.finishedAt!==null) return;
        let extra=0;
        if(state.config.mode==='random'){
          extra=(Math.random()*3)-1; // -1~+2
        } else {
          extra=0.4+Math.random()*0.2;
        }
        extra+=applyItem(r);
        r.itemCooldown=Math.max(0,r.itemCooldown-1);
        if(r.slowUntil && performance.now()<r.slowUntil) extra*=0.5;
        if(extra<0 && r.shield) extra=0; // 방패로 감속 무효화
        r.x+=baseStep()+extra;
        if(r.x<0) r.x=0;
        if(r.x>=state.lengthPx){ r.x=state.lengthPx; r.finishedAt=performance.now(); state.finished.push(r); }
        r.el.style.left=r.x+"px";
      });
      // 카메라 따라가기
      const leader=state.racers.reduce((a,b)=>a.x>b.x?a:b,state.racers[0]);
      const targetX=leader.x-window.innerWidth/2+200;
      trackEl.scrollLeft=Math.max(0,targetX);
      if(state.finished.length===state.racers.length){endRace();return;}
      state.raf=requestAnimationFrame(tick);
    }
    function startRace(){
      if(state.running)return;
      state.config.mode=modeSel.value; state.config.length=lenSel.value;
      buildTrack(collectNames());
      state.running=true;
      state.raf=requestAnimationFrame(tick);
    }
    function endRace(){
      cancelAnimationFrame(state.raf); state.running=false; rerunBtn.disabled=false;
      resultsEl.innerHTML="결과: "+state.finished.map((r,i)=>`<span class="badge">${i+1}위 ${r.name}${i===0?" 🏆":""}</span>`).join(" ");
    }
    function resetAll(){
      if(state.raf) cancelAnimationFrame(state.raf);
      state.running=false;state.racers=[];state.finished=[];resultsEl.innerHTML='';
      trackEl.innerHTML='<div class="lanes-wrapper"></div>'; rerunBtn.disabled=true;
    }
    function rerun(){
      if(!state.racers.length){startRace();return;}
      state.racers.forEach(r=>{r.x=0;r.finishedAt=null;r.el.style.left="0px";});
      state.finished=[];resultsEl.innerHTML='';state.running=true;rerunBtn.disabled=true;
      state.raf=requestAnimationFrame(tick);
    }

    applyBtn.addEventListener('click',()=>makeNameFields(countInput.value));
    startBtn.addEventListener('click',startRace);
    resetBtn.addEventListener('click',resetAll);
    rerunBtn.addEventListener('click',rerun);
    makeNameFields(countInput.value);
  </script>
</body>
</html>
